<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wikimedia Commons â€” Media Statistics Dashboard</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --accent: #58a6ff;
      --muted: #8b949e;
      --text: #e6edf3;
    }
    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
    }
    .container { max-width: 1200px; margin: auto; }
    header { text-align: center; margin-bottom: 1.5rem; }
    h1 { margin: 0; font-size: 1.6rem; color: var(--accent); }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 1rem; }
    .kpi {
      background: var(--card);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .kpi-label { color: var(--muted); font-size: 0.9rem; }
    .kpi-value { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
    .filters { text-align: center; margin: 1.2rem 0; }
    button.filter {
      background: var(--card);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 6px 14px;
      margin: 4px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.filter.active { background: var(--accent); color: #fff; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .chart-box {
      background: var(--card);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px; text-align: left; }
    th { color: var(--muted); }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š Wikimedia Commons â€” Media Statistics Dashboard</h1>
      <p style="color: var(--muted); font-size: 0.9rem;">Live data fetched daily from <a href="https://commons.wikimedia.org/wiki/Special:MediaStatistics" target="_blank" style="color: var(--accent);">Special:MediaStatistics</a></p>
    </header>

    <div class="kpis">
      <div class="kpi"><div class="kpi-label">Total Files</div><div id="kpi-files" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-label">Total Size (TiB)</div><div id="kpi-size" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-label">Top by Count</div><div id="kpi-top-count" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-label">Top by Size</div><div id="kpi-top-size" class="kpi-value">â€”</div></div>
    </div>

    <div class="filters">
      <button class="filter active" data-group="all">All</button>
      <button class="filter" data-group="images">Images</button>
      <button class="filter" data-group="audio">Audio</button>
      <button class="filter" data-group="video">Video</button>
      <button class="filter" data-group="documents">Office</button>
      <button class="filter" data-group="3d">3D</button>
    </div>

    <div class="grid">
      <div class="chart-box"><div id="pie-chart"></div></div>
      <div class="chart-box"><div id="bar-chart"></div></div>
    </div>
    <div class="chart-box" style="margin-top:12px;"><div id="top10-chart"></div></div>

    <div class="chart-box" style="margin-top:12px;overflow:auto;max-height:450px;">
      <table id="data-table">
        <thead><tr><th>MIME type</th><th>Extensions</th><th>Files</th><th>Size (TiB)</th><th>% of total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  async function loadData() {
    const res = await fetch('data/media_stats.json?_=' + Date.now());
    const json = await res.json();
    return json.entries;
  }

  function bytesToTB(b) { return +(b / (1024 ** 4)).toFixed(3); }

  loadData().then(DATA => {
    const totalFiles = DATA.reduce((s,d)=>s+d.files,0);
    const totalBytes = DATA.reduce((s,d)=>s+d.size_bytes,0);
    document.getElementById('kpi-files').textContent = totalFiles.toLocaleString();
    document.getElementById('kpi-size').textContent = bytesToTB(totalBytes);

    const topByCount = DATA.slice().sort((a,b)=>b.files-a.files)[0];
    const topBySize = DATA.slice().sort((a,b)=>b.size_bytes-a.size_bytes)[0];
    document.getElementById('kpi-top-count').textContent = topByCount.mime;
    document.getElementById('kpi-top-size').textContent = topBySize.mime;

    function render(group){
      let rows = DATA.slice();
      if(group==='images') rows = rows.filter(r=>r.mime.startsWith('image/'));
      if(group==='audio') rows = rows.filter(r=>r.mime.startsWith('audio/')||r.mime==='application/ogg');
      if(group==='video') rows = rows.filter(r=>r.mime.startsWith('video/'));
      if(group==='documents') rows = rows.filter(r=>r.mime.includes('pdf')||r.mime==='image/vnd.djvu');
      if(group==='3d') rows = rows.filter(r=>r.mime.includes('sla')||r.mime.includes('stl'));

      const top10 = rows.slice().sort((a,b)=>b.size_bytes-a.size_bytes).slice(0,10);

      Plotly.newPlot('pie-chart', [{
        labels: rows.map(r=>r.mime),
        values: rows.map(r=>r.files),
        type: 'pie',
        textinfo: 'label+percent',
        hovertemplate: '%{label}<br>%{value:,} files<extra></extra>'
      }], {
        title: 'File Count Distribution',
        paper_bgcolor:'transparent', plot_bgcolor:'transparent',
        font:{color:'#e6edf3'}
      });

      Plotly.newPlot('bar-chart', [{
        x: rows.map(r=>r.mime),
        y: rows.map(r=>bytesToTB(r.size_bytes)),
        type: 'bar',
        marker:{color:'#58a6ff'},
        hovertemplate: '%{x}<br>%{y} TiB<extra></extra>'
      }], {
        title: 'Total Size by MIME Type (TiB)',
        xaxis:{tickangle:-45}, margin:{t:50,b:120},
        paper_bgcolor:'transparent', plot_bgcolor:'transparent',
        font:{color:'#e6edf3'}
      });

      Plotly.newPlot('top10-chart', [{
        x: top10.map(r=>r.mime),
        y: top10.map(r=>bytesToTB(r.size_bytes)),
        type:'bar', marker:{color:'#00b8a9'},
        hovertemplate:'%{x}<br>%{y} TiB<extra></extra>'
      }], {
        title: 'Top 10 Largest MIME Types',
        xaxis:{tickangle:-45}, margin:{t:50,b:120},
        paper_bgcolor:'transparent', plot_bgcolor:'transparent',
        font:{color:'#e6edf3'}
      });

      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = "";
      rows.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.mime}</td><td>${d.ext}</td><td>${d.files.toLocaleString()}</td><td>${bytesToTB(d.size_bytes)}</td><td>${((d.size_bytes/totalBytes)*100).toFixed(2)}%</td>`;
        tbody.appendChild(tr);
      });
    }

    document.querySelectorAll('.filter').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.filter').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.group);
      });
    });

    render('all');
  });
  </script>
</body>
</html>
